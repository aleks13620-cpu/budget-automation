# Инструкция оператора: обучение системы на реальных данных

## Что делает система

Система помогает сопоставить позиции из вашей спецификации (что нужно купить) с позициями из счетов поставщиков (что предлагают). На выходе — итоговая таблица Excel с лучшими ценами по каждой позиции.

Чем больше проектов вы обработаете — тем умнее станет система. Она запоминает ваши решения и в следующий раз предложит правильные сопоставления автоматически.

---

## Перед началом работы

1. Убедитесь, что сервер запущен (бэкенд на порту 3001, фронтенд на порту 5173)
2. Откройте браузер и перейдите на http://localhost:5173
3. Вы увидите страницу **"Проекты"**

---

## Шаг 1. Создание проекта

На странице "Проекты":

1. В поле **"Название"** введите название вашего проекта (например, "ЖК Солнечный — инженерные сети")
2. В поле **"Описание"** можно добавить пометку (необязательно)
3. Нажмите кнопку **"Создать"**
4. Проект появится в таблице ниже

Нажмите на строку проекта, чтобы перейти к нему.

---

## Шаг 2. Загрузка спецификации

Спецификация — это Excel-файл от заказчика с перечнем того, что нужно закупить.

1. В разделе **"Спецификация"** нажмите **"Выберите файл"** и укажите ваш `.xlsx` или `.xls` файл
2. Нажмите **"Загрузить"**
3. Система автоматически найдёт в файле таблицу с позициями и определит колонки (наименование, количество, единицы и т.д.)
4. Позиции появятся в таблице. Проверьте, что данные считались верно
5. Каждой позиции система автоматически присвоит раздел (Электрика, ВК, Вентиляция, Отопление) по ключевым словам в названии

**Если что-то пошло не так:** удалите спецификацию и загрузите заново. Убедитесь, что в файле есть строка-заголовок с колонками "Наименование", "Количество" и т.п.

---

## Шаг 3. Загрузка счетов от поставщиков

Счета — это файлы от поставщиков (PDF или Excel) с перечнем товаров и ценами.

1. В разделе **"Счета"** нажмите **"Выберите файл"** и укажите файл счёта (`.pdf`, `.xlsx` или `.xls`)
2. Нажмите **"Загрузить счёт"**
3. Система автоматически:
   - Определит поставщика (по тексту документа)
   - Найдёт таблицу с позициями
   - Извлечёт наименования, артикулы, цены, количество
4. Загруженный счёт появится в таблице с количеством найденных позиций

**Загрузите все счета** от разных поставщиков по этому проекту — чем больше, тем лучше для сравнения цен.

---

## Шаг 3а. Настройка парсера (если система неправильно прочитала счёт)

Иногда система не может правильно определить, где какие колонки в счёте. Это нормально — форматы у всех поставщиков разные.

1. В таблице счетов нажмите кнопку **"Предпросмотр"** напротив нужного счёта
2. Откроется страница с сырыми данными файла и настройками колонок
3. Укажите **строку заголовка** (та строка, где написано "Наименование", "Цена" и т.п.)
4. Для каждого поля выберите номер колонки из выпадающего списка:
   - **Артикул** — код товара (если есть)
   - **Наименование** — название товара (обязательно)
   - **Ед. изм.** — единица измерения
   - **Количество** — сколько штук
   - **Цена** — цена за единицу
   - **Сумма** — итоговая сумма по позиции
5. Нажмите **"Сохранить настройки"**

**Важно:** настройки сохраняются для этого поставщика. Когда вы в следующий раз загрузите счёт от того же поставщика — система применит эти настройки автоматически. Настраивать нужно только один раз для каждого поставщика.

---

## Шаг 4. Запуск сопоставления

Когда загружены и спецификация, и хотя бы один счёт:

1. Нажмите кнопку **"Сопоставить позиции"** в разделе "Сопоставление"
2. Откроется страница сопоставления
3. Нажмите **"Запустить сопоставление"**
4. Система проанализирует все позиции и попытается найти совпадения

Сверху вы увидите статистику:
- **Всего** — сколько позиций в спецификации
- **Сопоставлено** — для скольких нашлись варианты в счетах
- **Подтверждено** — сколько вы уже подтвердили
- **Без матча** — для скольких не нашлось вариантов

---

## Шаг 5. Проверка и подтверждение сопоставлений

Это самый важный этап — здесь вы обучаете систему.

### Что вы видите в таблице

Каждая строка — это позиция из спецификации и лучший найденный вариант из счетов:

- **Зелёные строки** — уже подтверждённые
- **Жёлтые строки** — есть кандидаты, но ещё не подтверждены
- **Серые строки** — совпадений не найдено

### Фильтры

Используйте кнопки-фильтры сверху, чтобы показать только нужные позиции:
- **"Все"** — все позиции
- **"Подтверждённые"** — только зелёные
- **"Требуют проверки"** — только жёлтые (начните с них)
- **"Не найдены"** — только серые

### Как подтверждать

Для каждой жёлтой строки посмотрите на предложенный вариант и нажмите одну из кнопок:

- **✓** (галочка) — **Подтвердить**. Нажимайте, если позиция из счёта точно соответствует позиции из спецификации. Система запомнит эту связь с высокой уверенностью (90%).

- **≈** (приблизительно) — **Подтвердить как аналог**. Нажимайте, если позиция из счёта — это не то же самое, но подходящая замена. Система запомнит связь, но с меньшей уверенностью (75%).

- **✕** (крестик) — **Отклонить**. Нажимайте, если предложенный вариант совсем не подходит. Система удалит этот вариант.

### Если есть несколько кандидатов

Если для позиции найдено несколько вариантов, вы увидите кнопку с цифрой (например, **"▼ 3"**). Нажмите её, чтобы развернуть список всех кандидатов.

В развёрнутом списке:
- Можно **подтвердить** или **отклонить** любой из кандидатов
- Кнопка **●** позволяет **выбрать** конкретный вариант для итоговой спецификации (например, если вы хотите не самый дешёвый, а определённый)
- Зелёная галочка "выбран" показывает, какой вариант сейчас будет в экспорте

---

## Шаг 6. Просмотр итогов

После подтверждения сопоставлений на странице появится таблица **"Итоги по разделам"**:

| Раздел | Позиций | С ценой | Сумма |
|--------|---------|---------|-------|
| Электрика | 45 | 38 | 1 234 567,00 |
| ВК | 30 | 25 | 567 890,00 |
| ... | ... | ... | ... |
| **ОБЩИЙ ИТОГ** | | | **1 802 457,00** |

- **Позиций** — сколько позиций в разделе
- **С ценой** — для скольких найдена цена (есть выбранный матч)
- **Сумма** — общая сумма по разделу (цена × количество из спецификации)

---

## Шаг 7. Экспорт в Excel

Когда всё проверено и подтверждено:

1. Нажмите кнопку **"Экспорт в Excel"** в правом верхнем углу
2. Скачается файл `.xlsx` с итоговой спецификацией
3. В файле:
   - Заголовок с названием проекта и датой
   - Позиции сгруппированы по разделам
   - Для каждой позиции: наименование, единица, количество, цена, сумма, поставщик
   - Итоги по каждому разделу
   - Общий итог внизу

---

## Как система обучается

Каждый раз, когда вы подтверждаете сопоставление, система создаёт **правило**: "Если в спецификации написано **X**, а в счёте написано **Y** — это одно и то же".

При обработке следующего проекта система:
1. Сначала проверит точные совпадения артикулов
2. Затем проверит выученные правила (из ваших подтверждений)
3. Потом попробует нечёткое совпадение по названию
4. Наконец, сравнит название + характеристики

С каждым проектом правил становится больше, и система всё лучше сопоставляет автоматически.

**Примерная динамика:**
- 1-й проект: система находит 60-70% совпадений, вы тратите 3-4 часа на проверку
- 5-й проект: система находит 75-80%, вы тратите ~1 час
- 10-й проект: система находит 80-85%, вы тратите ~30 минут

---

## Советы

1. **Начните с одного проекта** — загрузите спецификацию и все счета, пройдите полный цикл. Это создаст базу правил.

2. **Подтверждайте точно** — не нажимайте "✓" если не уверены. Лучше нажать "≈" (аналог) или "✕" (отклонить). Неточные подтверждения ухудшат будущие результаты.

3. **Настройте парсеры для основных поставщиков** — потратьте 5 минут на "Предпросмотр" первого счёта от каждого поставщика. Дальше все счета от него будут читаться правильно.

4. **Используйте фильтры** — начинайте проверку с фильтра "Требуют проверки", потом переходите к "Не найдены".

5. **Перезапускайте сопоставление** — если загрузили новые счета, нажмите "Запустить сопоставление" снова. Подтверждённые решения сохранятся, а для остальных система поищет совпадения заново.

6. **Выбор цены** — по умолчанию система выбирает вариант с наивысшей уверенностью сопоставления. Если нужна конкретная цена (например, самая низкая) — разверните кандидатов и нажмите ● рядом с нужным.

---

## Частые вопросы

**В: Система не нашла совпадений для позиции. Что делать?**
О: Проверьте, есть ли эта позиция хотя бы в одном из счетов. Если есть, но система не нашла — возможно, названия слишком разные. Загрузите больше счетов или подождите: после обработки нескольких проектов система накопит правила и начнёт находить.

**В: Я случайно подтвердил неправильное сопоставление. Как исправить?**
О: Запустите сопоставление заново. Ошибочное подтверждение сохранится, но вы можете выбрать другой вариант через ● в развёрнутом списке кандидатов.

**В: Система неправильно читает PDF-счёт. Колонки перепутаны.**
О: Откройте "Предпросмотр" этого счёта и вручную укажите правильные колонки. Сохраните настройки — они применятся для всех будущих счетов от этого поставщика.

**В: Можно ли работать с несколькими проектами одновременно?**
О: Да. Каждый проект независим. Но правила сопоставления — общие для всех проектов. Чем больше проектов обработано, тем умнее система.

**В: Как сделать резервную копию?**
О: Скопируйте файл `database/budget_automation.db` — в нём все данные: проекты, счета, правила. Для восстановления просто замените файл обратно.
